<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoSound</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');

        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body, #app {
            height: 100%;
            overflow: hidden;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            user-select: none;
        }

        .device-card {
            transition: all 0.15s ease;
            border-left: 3px solid transparent;
        }

        .device-card:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .device-card.selected {
            background: rgba(14, 165, 233, 0.2);
            border-left-color: #0ea5e9;
        }

        .device-card.saved {
            background: rgba(34, 197, 94, 0.15);
            border-left-color: #22c55e;
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 5px;
        }

        .scrollbar-thin::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 3px;
        }

        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 3px;
        }

        .glass {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .pulse-dot {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .btn-save {
            transition: all 0.2s ease;
        }

        .btn-save:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .btn-save:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        .modal-enter {
            animation: modalEnter 0.2s ease-out;
        }

        @keyframes modalEnter {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Volume Slider Styles */
        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .volume-slider:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.4);
            transition: all 0.2s ease;
        }

        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.5);
        }

        .volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.4);
        }

        .volume-slider.input-volume::-webkit-slider-thumb {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
        }

        .volume-slider.input-volume::-webkit-slider-thumb:hover {
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.5);
        }

        .volume-slider.input-volume::-moz-range-thumb {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.4);
        }

        .volume-value {
            font-variant-numeric: tabular-nums;
            min-width: 36px;
            text-align: right;
        }
    </style>
</head>
<body class="dark">
    <!-- Autostart Modal -->
    <div id="autostartModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden">
        <div class="modal-enter glass rounded-2xl p-5 mx-4 max-w-sm w-full">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary-500 to-primary-600 flex items-center justify-center">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
                        <path d="M3 16.5c-.41 0-.75-.34-.75-.75v-7.5c0-.41.34-.75.75-.75s.75.34.75.75v7.5c0 .41-.34.75-.75.75M7.5 19c-.41 0-.75-.34-.75-.75V5.75c0-.41.34-.75.75-.75s.75.34.75.75v12.5c0 .41-.34.75-.75.75m4.5 2.5c-.41 0-.75-.34-.75-.75V3.25c0-.41.34-.75.75-.75s.75.34.75.75v17.5c0 .41-.34.75-.75.75m4.5-2.5c-.41 0-.75-.34-.75-.75V5.75c0-.41.34-.75.75-.75s.75.34.75.75v12.5c0 .41-.34.75-.75.75m4.5-2.5c-.41 0-.75-.34-.75-.75v-7.5c0-.41.34-.75.75-.75s.75.34.75.75v7.5c0 .41-.34.75-.75.75" fill="#ffffff"/>
                    </svg>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-white">Автозапуск</h3>
                    <p class="text-xs text-slate-400">Запускать при старте Windows?</p>
                </div>
            </div>
            <p class="text-xs text-slate-400 mb-4">
                AutoSound может запускаться автоматически при включении компьютера для постоянного контроля аудиоустройств.
            </p>
            <div class="flex gap-2">
                <button onclick="enableAutostart()" class="flex-1 px-4 py-2 bg-primary-600 hover:bg-primary-500 text-white text-xs font-medium rounded-lg transition-colors">
                    Включить
                </button>
                <button onclick="dismissAutostartModal()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white text-xs font-medium rounded-lg transition-colors">
                    Не сейчас
                </button>
            </div>
        </div>
    </div>

    <div id="app" class="h-full flex flex-col p-4">
        <!-- Header (draggable) -->
        <div class="flex items-center justify-between mb-4 flex-shrink-0" style="--wails-draggable:drag">
            <div class="flex items-center gap-2.5" style="--wails-draggable:drag">
                <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-primary-500 to-primary-600 flex items-center justify-center shadow-lg shadow-primary-500/20">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
                        <path d="M3 16.5c-.41 0-.75-.34-.75-.75v-7.5c0-.41.34-.75.75-.75s.75.34.75.75v7.5c0 .41-.34.75-.75.75M7.5 19c-.41 0-.75-.34-.75-.75V5.75c0-.41.34-.75.75-.75s.75.34.75.75v12.5c0 .41-.34.75-.75.75m4.5 2.5c-.41 0-.75-.34-.75-.75V3.25c0-.41.34-.75.75-.75s.75.34.75.75v17.5c0 .41-.34.75-.75.75m4.5-2.5c-.41 0-.75-.34-.75-.75V5.75c0-.41.34-.75.75-.75s.75.34.75.75v12.5c0 .41-.34.75-.75.75m4.5-2.5c-.41 0-.75-.34-.75-.75v-7.5c0-.41.34-.75.75-.75s.75.34.75.75v7.5c0 .41-.34.75-.75.75" fill="#ffffff"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-base font-semibold text-white leading-tight">AutoSound <span class="text-xs font-normal text-slate-400">v2.1.0</span></h1>
                    <p class="text-xs text-slate-500">Выберите устройства по умолчанию</p>
                </div>
            </div>
            <div class="flex items-center gap-1" style="--wails-draggable:no-drag">
                <button onclick="minimizeWindow()" class="p-2 rounded-lg hover:bg-white/10 transition-colors" title="Свернуть">
                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                    </svg>
                </button>
                <button onclick="hideWindow()" class="p-2 rounded-lg hover:bg-white/10 transition-colors" title="В трей">
                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <button onclick="quitApp()" class="p-2 rounded-lg hover:bg-red-500/20 transition-colors" title="Закрыть">
                    <svg class="w-4 h-4 text-slate-400 hover:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Device Lists -->
        <div class="grid grid-cols-2 gap-3 flex-1 min-h-0 mb-3">
            <!-- Output Devices -->
            <div class="glass rounded-xl p-3 flex flex-col min-h-0">
                <div class="flex items-center gap-2 mb-2 flex-shrink-0">
                    <svg class="w-4 h-4" viewBox="-10.5 0 53.763 53.763" fill="none">
                        <g stroke="#38bdf8" stroke-linecap="round" stroke-linejoin="round" stroke-width="4">
                            <rect x="2" y="2" width="28.758" height="49.763" fill="rgba(56,189,248,0.1)"/>
                            <circle cx="16.379" cy="14.908" r="4.857" fill="rgba(56,189,248,0.2)"/>
                            <circle cx="16.379" cy="36.193" r="7.661" fill="rgba(56,189,248,0.2)"/>
                            <line x1="25.49" y1="7.533" x2="25.49" y2="8.783"/>
                        </g>
                    </svg>
                    <h2 class="text-xs font-medium text-slate-300">Вывод звука</h2>
                </div>
                <div id="outputDevices" class="flex-1 overflow-y-auto scrollbar-thin space-y-0.5 pr-1">
                    <div class="text-slate-500 text-xs py-8 text-center">Загрузка...</div>
                </div>
            </div>

            <!-- Input Devices -->
            <div class="glass rounded-xl p-3 flex flex-col min-h-0">
                <div class="flex items-center gap-2 mb-2 flex-shrink-0">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="#4ade80">
                        <path d="M12 15a4 4 0 0 0 4-4V5a4 4 0 0 0-8 0v6a4 4 0 0 0 4 4M10 5a2 2 0 0 1 4 0v6a2 2 0 0 1-4 0Zm10 6a1 1 0 0 0-2 0 6 6 0 0 1-12 0 1 1 0 0 0-2 0 8 8 0 0 0 7 7.93V21H9a1 1 0 0 0 0 2h6a1 1 0 0 0 0-2h-2v-2.07A8 8 0 0 0 20 11"/>
                    </svg>
                    <h2 class="text-xs font-medium text-slate-300">Микрофон</h2>
                </div>
                <div id="inputDevices" class="flex-1 overflow-y-auto scrollbar-thin space-y-0.5 pr-1">
                    <div class="text-slate-500 text-xs py-8 text-center">Загрузка...</div>
                </div>
            </div>
        </div>

        <!-- Volume Controls -->
        <div class="glass rounded-xl p-3 mb-3 flex-shrink-0">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="#38bdf8">
                        <path d="M3 16.5c-.41 0-.75-.34-.75-.75v-7.5c0-.41.34-.75.75-.75s.75.34.75.75v7.5c0 .41-.34.75-.75.75M7.5 19c-.41 0-.75-.34-.75-.75V5.75c0-.41.34-.75.75-.75s.75.34.75.75v12.5c0 .41-.34.75-.75.75m4.5 2.5c-.41 0-.75-.34-.75-.75V3.25c0-.41.34-.75.75-.75s.75.34.75.75v17.5c0 .41-.34.75-.75.75m4.5-2.5c-.41 0-.75-.34-.75-.75V5.75c0-.41.34-.75.75-.75s.75.34.75.75v12.5c0 .41-.34.75-.75.75m4.5-2.5c-.41 0-.75-.34-.75-.75v-7.5c0-.41.34-.75.75-.75s.75.34.75.75v7.5c0 .41-.34.75-.75.75"/>
                    </svg>
                    <h2 class="text-xs font-medium text-slate-300">Громкость</h2>
                </div>
                <!-- Lock Volume Toggle -->
                <div class="flex items-center gap-2">
                    <div id="lockVolumeIndicator" class="w-1.5 h-1.5 rounded-full bg-slate-600 flex-shrink-0"></div>
                    <span class="text-[10px] text-slate-400">Фиксировать</span>
                    <label class="relative inline-flex items-center cursor-pointer flex-shrink-0">
                        <input type="checkbox" id="lockVolumeToggle" class="sr-only peer" onchange="toggleLockVolume()">
                        <div class="w-7 h-3.5 bg-slate-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:rounded-full after:h-2.5 after:w-2.5 after:transition-all peer-checked:bg-amber-600"></div>
                    </label>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <!-- Output Volume -->
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-1.5">
                            <svg class="w-3.5 h-3.5" viewBox="-10.5 0 53.763 53.763" fill="none">
                                <g stroke="#38bdf8" stroke-linecap="round" stroke-linejoin="round" stroke-width="5">
                                    <rect x="2" y="2" width="28.758" height="49.763" fill="rgba(56,189,248,0.1)"/>
                                    <circle cx="16.379" cy="14.908" r="4.857" fill="rgba(56,189,248,0.2)"/>
                                    <circle cx="16.379" cy="36.193" r="7.661" fill="rgba(56,189,248,0.2)"/>
                                </g>
                            </svg>
                            <span class="text-[10px] text-slate-400">Вывод</span>
                        </div>
                        <span id="outputVolumeValue" class="text-xs text-slate-300 volume-value">0%</span>
                    </div>
                    <input type="range" id="outputVolumeSlider" min="0" max="100" value="0"
                           class="volume-slider" oninput="onOutputVolumeChange(this.value)" onchange="setOutputVolume(this.value)">
                </div>

                <!-- Input Volume -->
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-1.5">
                            <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="#4ade80">
                                <path d="M12 15a4 4 0 0 0 4-4V5a4 4 0 0 0-8 0v6a4 4 0 0 0 4 4M10 5a2 2 0 0 1 4 0v6a2 2 0 0 1-4 0Zm10 6a1 1 0 0 0-2 0 6 6 0 0 1-12 0 1 1 0 0 0-2 0 8 8 0 0 0 7 7.93V21H9a1 1 0 0 0 0 2h6a1 1 0 0 0 0-2h-2v-2.07A8 8 0 0 0 20 11"/>
                            </svg>
                            <span class="text-[10px] text-slate-400">Микрофон</span>
                        </div>
                        <span id="inputVolumeValue" class="text-xs text-slate-300 volume-value">0%</span>
                    </div>
                    <input type="range" id="inputVolumeSlider" min="0" max="100" value="0"
                           class="volume-slider input-volume" oninput="onInputVolumeChange(this.value)" onchange="setInputVolume(this.value)">
                </div>
            </div>
        </div>

        <!-- Bottom Panel -->
        <div class="flex items-center gap-2 flex-shrink-0">
            <!-- Auto-switch toggle -->
            <div class="glass rounded-xl px-2.5 py-2 flex items-center gap-2 flex-1">
                <div id="autoSwitchIndicator" class="w-1.5 h-1.5 rounded-full bg-green-500 pulse-dot flex-shrink-0"></div>
                <div class="flex-1 min-w-0">
                    <p class="text-[11px] font-medium text-slate-300">Авто-восстановление</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer flex-shrink-0">
                    <input type="checkbox" id="autoSwitchToggle" class="sr-only peer" onchange="toggleAutoSwitch()">
                    <div class="w-8 h-4 bg-slate-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-green-600"></div>
                </label>
            </div>

            <!-- Autostart toggle -->
            <div class="glass rounded-xl px-2.5 py-2 flex items-center gap-2 flex-1">
                <div id="autostartIndicator" class="w-1.5 h-1.5 rounded-full bg-slate-600 flex-shrink-0"></div>
                <div class="flex-1 min-w-0">
                    <p class="text-[11px] font-medium text-slate-300">Автозапуск</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer flex-shrink-0">
                    <input type="checkbox" id="autostartToggle" class="sr-only peer" onchange="toggleAutostart()">
                    <div class="w-8 h-4 bg-slate-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-primary-600"></div>
                </label>
            </div>

            <!-- Save Button -->
            <button id="saveBtn" onclick="saveSettings()" disabled
                    class="btn-save px-4 py-2 bg-slate-700 text-white text-xs font-medium rounded-xl flex items-center gap-1.5 flex-shrink-0">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span id="saveBtnText">Сохранено</span>
            </button>
        </div>
    </div>

    <script>
        let hasChanges = false;

        async function refreshDevices() {
            try {
                const outputDevices = await window.go.main.App.GetOutputDevices();
                const inputDevices = await window.go.main.App.GetInputDevices();
                renderDevices('outputDevices', outputDevices, 'output');
                renderDevices('inputDevices', inputDevices, 'input');
                await checkChanges();
            } catch (e) {
                console.error('Failed to refresh:', e);
            }
        }

        function renderDevices(containerId, devices, type) {
            const container = document.getElementById(containerId);
            if (!devices || devices.length === 0) {
                container.innerHTML = '<div class="text-slate-500 text-xs py-8 text-center">Нет устройств</div>';
                return;
            }

            // SVG иконки для устройств
            const speakerIcon = '<svg class="w-3.5 h-3.5" viewBox="-10.5 0 53.763 53.763" fill="none"><g stroke="#94a3b8" stroke-linecap="round" stroke-linejoin="round" stroke-width="5"><rect x="2" y="2" width="28.758" height="49.763" fill="rgba(148,163,184,0.1)"/><circle cx="16.379" cy="14.908" r="4.857" fill="rgba(148,163,184,0.15)"/><circle cx="16.379" cy="36.193" r="7.661" fill="rgba(148,163,184,0.15)"/></g></svg>';
            const micIcon = '<svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="#94a3b8"><path d="M12 15a4 4 0 0 0 4-4V5a4 4 0 0 0-8 0v6a4 4 0 0 0 4 4M10 5a2 2 0 0 1 4 0v6a2 2 0 0 1-4 0Zm10 6a1 1 0 0 0-2 0 6 6 0 0 1-12 0 1 1 0 0 0-2 0 8 8 0 0 0 7 7.93V21H9a1 1 0 0 0 0 2h6a1 1 0 0 0 0-2h-2v-2.07A8 8 0 0 0 20 11"/></svg>';

            container.innerHTML = devices.map(device => {
                const isSelected = device.isPending && !device.isChosen;
                const isSaved = device.isChosen && device.isPending;

                let cardClass = 'device-card';
                let textClass = 'text-slate-300';
                let iconBg = 'bg-slate-700/50';
                let icon = type === 'output' ? speakerIcon : micIcon;

                if (isSelected) {
                    // Выбрано, но ещё не сохранено (синий)
                    cardClass += ' selected';
                    textClass = 'text-white font-medium';
                    iconBg = 'bg-primary-500/30';
                    icon = '<svg class="w-3.5 h-3.5 text-primary-400" fill="currentColor" viewBox="0 0 20 20"><circle cx="10" cy="10" r="4"></circle></svg>';
                } else if (isSaved) {
                    // Сохранено (зелёный)
                    cardClass += ' saved';
                    textClass = 'text-white font-medium';
                    iconBg = 'bg-green-500/30';
                    icon = '<svg class="w-3.5 h-3.5 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';
                }

                const clickFn = type === 'output' ? 'selectOutputDevice' : 'selectInputDevice';

                return `
                <div class="${cardClass} px-2.5 py-2 rounded-lg cursor-pointer"
                     onclick="${clickFn}('${device.id}')">
                    <div class="flex items-center gap-2.5">
                        <div class="w-6 h-6 rounded-md ${iconBg} flex items-center justify-center flex-shrink-0">
                            ${icon}
                        </div>
                        <div class="min-w-0 flex-1">
                            <span class="text-xs ${textClass} block truncate">${device.name}</span>
                        </div>
                        ${device.isDefault ? '<span class="text-[9px] text-slate-500 flex-shrink-0 bg-slate-700/50 px-1.5 py-0.5 rounded">sys</span>' : ''}
                    </div>
                </div>
            `}).join('');
        }

        async function selectOutputDevice(deviceId) {
            try {
                await window.go.main.App.SelectOutputDevice(deviceId);
                await refreshDevices();
            } catch (e) {
                console.error('Failed to select output:', e);
            }
        }

        async function selectInputDevice(deviceId) {
            try {
                await window.go.main.App.SelectInputDevice(deviceId);
                await refreshDevices();
            } catch (e) {
                console.error('Failed to select input:', e);
            }
        }

        async function checkChanges() {
            try {
                hasChanges = await window.go.main.App.HasUnsavedChanges();
                updateSaveButton();
            } catch (e) {
                console.error('Failed to check changes:', e);
            }
        }

        function updateSaveButton() {
            const btn = document.getElementById('saveBtn');
            const text = document.getElementById('saveBtnText');

            if (hasChanges) {
                btn.disabled = false;
                text.textContent = 'Сохранить';
                btn.className = 'btn-save px-5 py-2.5 bg-green-600 hover:bg-green-500 text-white text-sm font-medium rounded-xl flex items-center gap-2';
            } else {
                btn.disabled = true;
                text.textContent = 'Сохранено';
                btn.className = 'btn-save px-5 py-2.5 bg-slate-700 text-white text-sm font-medium rounded-xl flex items-center gap-2';
            }
        }

        async function saveSettings() {
            if (!hasChanges) return;

            const btn = document.getElementById('saveBtn');
            const text = document.getElementById('saveBtnText');

            btn.disabled = true;
            text.textContent = 'Сохранение...';

            try {
                await window.go.main.App.SaveSettings();
                await refreshDevices();
                text.textContent = 'Готово!';
                setTimeout(updateSaveButton, 1000);
            } catch (e) {
                console.error('Failed to save:', e);
                text.textContent = 'Ошибка';
                btn.className = 'btn-save px-5 py-2.5 bg-red-600 text-white text-sm font-medium rounded-xl flex items-center gap-2';
                setTimeout(() => {
                    updateSaveButton();
                    refreshDevices();
                }, 2000);
            }
        }

        async function toggleAutoSwitch() {
            const toggle = document.getElementById('autoSwitchToggle');
            const indicator = document.getElementById('autoSwitchIndicator');
            try {
                await window.go.main.App.SetAutoSwitch(toggle.checked);
                indicator.className = toggle.checked
                    ? 'w-1.5 h-1.5 rounded-full bg-green-500 pulse-dot'
                    : 'w-1.5 h-1.5 rounded-full bg-slate-600';
            } catch (e) {
                console.error('Failed to toggle:', e);
            }
        }

        async function loadAutoSwitchState() {
            try {
                const enabled = await window.go.main.App.GetAutoSwitch();
                document.getElementById('autoSwitchToggle').checked = enabled;
                document.getElementById('autoSwitchIndicator').className = enabled
                    ? 'w-1.5 h-1.5 rounded-full bg-green-500 pulse-dot flex-shrink-0'
                    : 'w-1.5 h-1.5 rounded-full bg-slate-600 flex-shrink-0';
            } catch (e) {}
        }

        async function loadAutostartState() {
            try {
                const enabled = await window.go.main.App.GetAutostartEnabled();
                document.getElementById('autostartToggle').checked = enabled;
                document.getElementById('autostartIndicator').className = enabled
                    ? 'w-1.5 h-1.5 rounded-full bg-primary-500 pulse-dot flex-shrink-0'
                    : 'w-1.5 h-1.5 rounded-full bg-slate-600 flex-shrink-0';
            } catch (e) {}
        }

        // Volume functions
        async function loadVolumeState() {
            try {
                const volumes = await window.go.main.App.GetVolumes();

                const outputValue = Math.round(volumes.outputVolume * 100);
                const inputValue = Math.round(volumes.inputVolume * 100);

                document.getElementById('outputVolumeSlider').value = outputValue;
                document.getElementById('outputVolumeValue').textContent = outputValue + '%';

                document.getElementById('inputVolumeSlider').value = inputValue;
                document.getElementById('inputVolumeValue').textContent = inputValue + '%';

                document.getElementById('lockVolumeToggle').checked = volumes.lockVolume;
                document.getElementById('lockVolumeIndicator').className = volumes.lockVolume
                    ? 'w-1.5 h-1.5 rounded-full bg-amber-500 pulse-dot flex-shrink-0'
                    : 'w-1.5 h-1.5 rounded-full bg-slate-600 flex-shrink-0';
            } catch (e) {
                console.error('Failed to load volume state:', e);
            }
        }

        function onOutputVolumeChange(value) {
            document.getElementById('outputVolumeValue').textContent = value + '%';
        }

        function onInputVolumeChange(value) {
            document.getElementById('inputVolumeValue').textContent = value + '%';
        }

        async function setOutputVolume(value) {
            try {
                const level = value / 100;
                await window.go.main.App.SetOutputVolume(level);
            } catch (e) {
                console.error('Failed to set output volume:', e);
            }
        }

        async function setInputVolume(value) {
            try {
                const level = value / 100;
                await window.go.main.App.SetInputVolume(level);
            } catch (e) {
                console.error('Failed to set input volume:', e);
            }
        }

        async function toggleLockVolume() {
            const toggle = document.getElementById('lockVolumeToggle');
            const indicator = document.getElementById('lockVolumeIndicator');
            try {
                await window.go.main.App.SetLockVolume(toggle.checked);
                indicator.className = toggle.checked
                    ? 'w-1.5 h-1.5 rounded-full bg-amber-500 pulse-dot flex-shrink-0'
                    : 'w-1.5 h-1.5 rounded-full bg-slate-600 flex-shrink-0';
            } catch (e) {
                console.error('Failed to toggle lock volume:', e);
                toggle.checked = !toggle.checked;
            }
        }

        async function toggleAutostart() {
            const toggle = document.getElementById('autostartToggle');
            const indicator = document.getElementById('autostartIndicator');
            try {
                await window.go.main.App.SetAutostartEnabled(toggle.checked);
                indicator.className = toggle.checked
                    ? 'w-1.5 h-1.5 rounded-full bg-primary-500 pulse-dot flex-shrink-0'
                    : 'w-1.5 h-1.5 rounded-full bg-slate-600 flex-shrink-0';
            } catch (e) {
                console.error('Failed to toggle autostart:', e);
                toggle.checked = !toggle.checked;
            }
        }

        async function checkAutostartPrompt() {
            try {
                const shouldShow = await window.go.main.App.ShouldShowAutostartPrompt();
                if (shouldShow) {
                    document.getElementById('autostartModal').classList.remove('hidden');
                }
            } catch (e) {}
        }

        async function enableAutostart() {
            try {
                await window.go.main.App.SetAutostartEnabled(true);
                await window.go.main.App.MarkAutostartAsked();
                document.getElementById('autostartModal').classList.add('hidden');
                await loadAutostartState();
            } catch (e) {
                console.error('Failed to enable autostart:', e);
            }
        }

        async function dismissAutostartModal() {
            try {
                await window.go.main.App.MarkAutostartAsked();
                document.getElementById('autostartModal').classList.add('hidden');
            } catch (e) {}
        }

        function minimizeWindow() {
            try { window.go.main.App.MinimizeWindow(); } catch (e) {}
        }

        function hideWindow() {
            try { window.go.main.App.HideWindow(); } catch (e) {}
        }

        function quitApp() {
            try { window.go.main.App.Quit(); } catch (e) {}
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(async () => {
                await refreshDevices();
                await loadAutoSwitchState();
                await loadAutostartState();
                await loadVolumeState();
                await checkAutostartPrompt();
            }, 100);
        });
    </script>
</body>
</html>
